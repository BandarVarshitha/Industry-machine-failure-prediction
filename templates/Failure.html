{% extends "base.html" %}
{% block title %}Failure Analysis{% endblock %}
{% block content %}
<div class="container-fluid p-5">
    <!-- Failure Probability Gauge -->
    <div class="row justify-content-center">
        <div class="col-md-6 mb-4">
            <div class="dashboard-card mx-auto" style="width: 90%;">
                <h5 class="text-center text-white">Failure Probability Gauge</h5>
                <div id="failureProbabilityGauge" style="height: 400px;"></div>
            </div>
        </div>

        <!-- Top 5 At-Risk Machines -->
        <div class="col-md-6 mb-4">
            <div class="dashboard-card mx-auto" style="width: 90%;">
                <h5 class="text-center text-white">Top 5 At-Risk Machines</h5>
                <table class="table table-dark table-striped">
                    <thead>
                        <tr>
                            <th>Machine ID</th>
                            <th>Failure Type</th>
                            <th>Predicted Failure Time</th>
                        </tr>
                    </thead>
                    <tbody id="atRiskMachinesTable">
                        <!-- Data will be dynamically populated -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Failure Counts Over Time -->
    <div class="row justify-content-center">
        <div class="col-md-12 mb-4">
            <div class="dashboard-card mx-auto" style="width: 95%;">
                <h5 class="text-center text-white">Failure Counts Over Time</h5>
                <div id="failureCountsChart" style="height: 400px;"></div>
            </div>
        </div>
    </div>

    <!-- Failure Type Distribution -->
    <div class="row justify-content-center">
        <div class="col-md-6 mb-4">
            <div class="dashboard-card mx-auto" style="width: 90%;">
                <h5 class="text-center text-white">Failure Type Distribution</h5>
                <div id="failureTypeDistributionChart" style="height: 400px;"></div>
            </div>
        </div>
    </div>

    <!-- Feature Importance Bar Chart -->
    <div class="row justify-content-center">
        <div class="col-md-6 mb-4">
            <div class="dashboard-card mx-auto" style="width: 90%;">
                <h5 class="text-center text-white">Feature Importance</h5>
                <div id="featureImportanceChart" style="height: 400px;"></div>
            </div>
        </div>

        <!-- Time-Series Forecasting -->
        <div class="col-md-6 mb-4">
            <div class="dashboard-card mx-auto" style="width: 90%;">
                <h5 class="text-center text-white">Time-Series Forecasting</h5>
                <div id="timeSeriesForecastingChart" style="height: 400px;"></div>
            </div>
        </div>
    </div>

    <!-- Anomaly Detection Box Plots -->
    <div class="row justify-content-center">
        <div class="col-md-6 mb-4">
            <div class="dashboard-card mx-auto" style="width: 90%;">
                <h5 class="text-center text-white">Anomaly Detection</h5>
                <div id="anomalyDetectionBoxPlots" style="height: 400px;"></div>
            </div>
        </div>

        <!-- Confusion Matrix and ROC Curve -->
        <div class="col-md-6 mb-4">
            <div class="dashboard-card mx-auto" style="width: 90%;">
                <h5 class="text-center text-white">Model Performance</h5>
                <div id="confusionMatrix" style="height: 200px;"></div>
                <div id="rocCurve" style="height: 200px;"></div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Helper function to handle empty or invalid data
        function handleEmptyData(data, chartId, message) {
            if (!data || data.length === 0) {
                document.getElementById(chartId).innerHTML = `<p style="color: white; text-align: center;">${message}</p>`;
                return true;
            }
            return false;
        }

        // Failure Probability Gauge
        fetch('/api/failure-probability')
            .then(response => response.json())
            .then(data => {
                if (handleEmptyData(data, 'failureProbabilityGauge', 'No data available for Failure Probability')) return;

                const trace = {
                    type: "indicator",
                    mode: "gauge+number",
                    value: data.probability,
                    gauge: {
                        axis: { range: [0, 100] },
                        bar: { color: "#FF5733" },
                        steps: [
                            { range: [0, 50], color: "#4CAF50" },
                            { range: [50, 80], color: "#FFEB3B" },
                            { range: [80, 100], color: "#F44336" }
                        ]
                    }
                };
                const layout = {
                    plot_bgcolor: "#1e293b",
                    paper_bgcolor: "#1e293b",
                    font: { color: "#ffffff" }
                };
                Plotly.newPlot('failureProbabilityGauge', [trace], layout);
            });

        // Top 5 At-Risk Machines
        fetch('/api/at-risk-machines')
            .then(response => response.json())
            .then(data => {
                const tableBody = document.getElementById('atRiskMachinesTable');
                if (!data || data.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="3" class="text-center">No at-risk machines available</td></tr>';
                    return;
                }

                data.forEach(machine => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${machine.Machine_ID}</td>
                        <td>${machine.Failure_Type}</td>
                        <td>${machine.Predicted_Failure_Time}</td>
                    `;
                    tableBody.appendChild(row);
                });
            });

        // Failure Counts Over Time
        fetch('/api/historical-patterns')
            .then(response => response.json())
            .then(data => {
                if (handleEmptyData(data, 'failureCountsChart', 'No data available for Failure Counts Over Time')) return;

                const trace = {
                    x: data.timestamps,
                    y: data.failure_counts,
                    type: 'scatter',
                    mode: 'lines+markers',
                    marker: { color: '#FFC300' }
                };
                const layout = {
                    xaxis: { title: "Time (Grouped by Month)" },
                    yaxis: { title: "Failure Counts" },
                    plot_bgcolor: "#1e293b",
                    paper_bgcolor: "#1e293b",
                    font: { color: "#ffffff" }
                };
                Plotly.newPlot('failureCountsChart', [trace], layout);
            });

        // Failure Type Distribution
        fetch('/api/failure-type-distribution')
            .then(response => response.json())
            .then(data => {
                if (handleEmptyData(data, 'failureTypeDistributionChart', 'No data available for Failure Type Distribution')) return;

                const trace = {
                    labels: data.labels,
                    values: data.values,
                    type: 'pie',
                    marker: { colors: ['#4CAF50', '#FFEB3B', '#F44336'] }
                };
                const layout = {
                    plot_bgcolor: "#1e293b",
                    paper_bgcolor: "#1e293b",
                    font: { color: "#ffffff" }
                };
                Plotly.newPlot('failureTypeDistributionChart', [trace], layout);
            });

        // Feature Importance Bar Chart
        fetch('/api/feature-importance')
            .then(response => response.json())
            .then(data => {
                if (handleEmptyData(data, 'featureImportanceChart', 'No data available for Feature Importance')) return;

                const trace = {
                    x: data.labels,
                    y: data.values,
                    type: 'bar',
                    marker: { color: '#4CAF50' }
                };
                const layout = {
                    xaxis: { title: "Features" },
                    yaxis: { title: "Importance Score" },
                    plot_bgcolor: "#1e293b",
                    paper_bgcolor: "#1e293b",
                    font: { color: "#ffffff" }
                };
                Plotly.newPlot('featureImportanceChart', [trace], layout);
            });

        // Time-Series Forecasting
        fetch('/api/time-series-forecasting')
            .then(response => response.json())
            .then(data => {
                if (handleEmptyData(data, 'timeSeriesForecastingChart', 'No data available for Time-Series Forecasting')) return;

                const trace = {
                    x: data.timestamps,
                    y: data.probabilities,
                    type: 'line',
                    line: { color: '#FF5733' }
                };
                const layout = {
                    xaxis: { title: "Time" },
                    yaxis: { title: "Failure Probability" },
                    plot_bgcolor: "#1e293b",
                    paper_bgcolor: "#1e293b",
                    font: { color: "#ffffff" }
                };
                Plotly.newPlot('timeSeriesForecastingChart', [trace], layout);
            });

        // Anomaly Detection Box Plots
        fetch('/api/anomaly-detection')
            .then(response => response.json())
            .then(data => {
                if (handleEmptyData(data, 'anomalyDetectionBoxPlots', 'No data available for Anomaly Detection')) return;

                const trace = {
                    y: data.sensor_readings,
                    type: 'box',
                    marker: { color: '#FFC300' }
                };
                const layout = {
                    yaxis: { title: "Sensor Readings" },
                    plot_bgcolor: "#1e293b",
                    paper_bgcolor: "#1e293b",
                    font: { color: "#ffffff" }
                };
                Plotly.newPlot('anomalyDetectionBoxPlots', [trace], layout);
            });

        // Confusion Matrix
        fetch('/api/confusion-matrix')
            .then(response => response.json())
            .then(data => {
                if (handleEmptyData(data, 'confusionMatrix', 'No data available for Confusion Matrix')) return;

                const trace = {
                    z: data.matrix,
                    x: data.labels,
                    y: data.labels,
                    type: 'heatmap',
                    colorscale: 'Viridis'
                };
                const layout = {
                    xaxis: { title: "Predicted" },
                    yaxis: { title: "Actual" },
                    plot_bgcolor: "#1e293b",
                    paper_bgcolor: "#1e293b",
                    font: { color: "#ffffff" }
                };
                Plotly.newPlot('confusionMatrix', [trace], layout);
            });

        // ROC Curve
        fetch('/api/roc-curve')
            .then(response => response.json())
            .then(data => {
                if (handleEmptyData(data, 'rocCurve', 'No data available for ROC Curve')) return;

                const trace = {
                    x: data.fpr,
                    y: data.tpr,
                    type: 'scatter',
                    mode: 'lines',
                    line: { color: '#FF5733' }
                };
                const layout = {
                    xaxis: { title: "False Positive Rate" },
                    yaxis: { title: "True Positive Rate" },
                    plot_bgcolor: "#1e293b",
                    paper_bgcolor: "#1e293b",
                    font: { color: "#ffffff" }
                };
                Plotly.newPlot('rocCurve', [trace], layout);
            });
    });
</script>
{% endblock %}